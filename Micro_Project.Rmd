---
title: Microeconometrics, Empirical project, Group 8
author:
- Atanasov Georgi^[student ID 11776393]
- Fitter Jonathan^[student ID 11709902]
- Geyer Niklas^[student ID]
- Hochholzer Matthias^[student ID  11724853]
- Woharcik Verena^[student ID]
date: 7th February 2021
header-includes:
- \usepackage{fancyhdr}
- \usepackage{lastpage}
- \usepackage{graphicx}
- \pagestyle{fancy}
- \fancypagestyle{plain}{\pagestyle{fancy}}
- \fancyhead[L]{Empirical project} 
- \fancyhead[R]{\thepage\ of \pageref{LastPage}} 
- \fancyfoot[R]{\includegraphics[width=3cm]{Uni_Logo_blau.png}} 
- \fancyfoot[C]{}
- \setlength{\footskip}{46.27646pt}
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
#Loading packages
library(tidyverse)
library(foreign)
library(ggplot2)
library(ROCR)
library(ivpack)
```


## Importing data
from Wooldridge, his source: J. Grogger (1991), “Certainty vs. Severity of Punishment,” Economic Inquiry
29, 297-309.
```{r}
df<-read.dta("http://fmwww.bc.edu/ec-p/data/wooldridge/crime1.dta")
attach(df)
head(df)
str(df)
summary(df)
```
A data.frame with 2725 observations on 16 variables:
- narr86: times arrested, 1986
- nfarr86: felony arrests, 1986
- nparr86: property crme arr., 1986
- pcnv: proportion of prior convictions
- avgsen: avg sentence length, mos.
- tottime: time in prison since 18 (mos.)
- ptime86: mos. in prison during 1986
- qemp86: quarters employed, 1986
- inc86: legal income, 1986, $100s
- durat: recent unemp duration
- black: =1 if black
- hispan: =1 if Hispanic
- born60: =1 if born in 1960
- pcnvsq: pcnv^2
- pt86sq: ptime86^2
- inc86sq: inc86^2

### Correlation Plots

```{r}
plot(df[,c("narr86", "avgsen", "inc86", "durat")])
cor(df[,c("narr86", "avgsen", "inc86", "durat")])
```

### Specific Plots:

```{r, echo=FALSE}
plot(narr86, inc86, main = "Correlation, crime 1986", xlab= "times arrested", ylab="legal income", col="darkblue")
```

```{r, echo=FALSE}
plot(narr86, avgsen, main = "Correlation, crime 1986", xlab= "times arrested", ylab="avg sentence length, mos.", col="darkblue")
```

```{r, echo=FALSE}
barplot(table(ifelse(df$black==1,df$narr86,NA)), xlab = "times arrested", ylab = "amount", main = "Histogram Black/White", col="blue")
barplot(table(ifelse(df$black==0,df$narr86,NA)), xlab = "times arrested", ylab = "amount", main = "Histogram Black/White", col="red")
```

######################################
#############Georgi###################
######################################



##  ** Modeling "avgsen" **
Building model estimating expected severity of conviction when arrested in 1986 using level of income, employment, total time spend in prison and color (black ad non-black) of the arrested. Hypothesis, which are to be tested, are that the coefficient of every single variable is equal to 0.  

$$  avgsen = \beta_0 + \beta_1\ inc86 + \beta_2\ black +  \beta_3\ tottime +  \beta_4\ qemp86  $$ 


### Simple OLS-Estimation of the model

The average severity is regressed on the above mentioned variables.
```{r,include=TRUE}
lm_sev2<-lm(avgsen~ tottime+ black+ qemp86+ inc86, data = df) 

```
An output of an OLS-Estimation is given:
```{r}
summary((lm_sev2))
```
#### Interpretation of the OLS output

We see a high R-squared. The significant variables for 0.05 significance level are the total time spend in prison and the color. No significance of the other variables is proven.

#### Problems with the OLS 
Some of the variables may be ednogenuos E.g assumptions may be violated.
=> Testing  this way may not be correct.

### IV-Regression (using 2SLS-Estimation)
Use instrumental variables in the estimation of the expected severity.
Define:
endogenuos var: income86, qemp86, tottime
exogenuos var: black
instruments: durat, nparr, nfarr, narr, ptime86

The regression code is given by:
```{r, include=TRUE}
IV_sev1<-ivreg(avgsen~ tottime+ black+ qemp86+ inc86 | black+ durat+ narr86+ nfarr86+ nparr86+ ptime86  ,data=df)
```


#### Check if Instuments are adequate
1. Check if regressors and instruments are correlated
```{r ,include=TRUE}
i1lm_sev1<- lm(tottime~ black+ durat+ narr86+ nfarr86+ nparr86+ ptime86, data=df)
summary(i1lm_sev1)

i2lm_sev1<- lm(qemp86~ black+ durat+ narr86+ nfarr86+ nparr86+ ptime86, data=df)
summary(i2lm_sev1)

i3lm_sev1<- lm( inc86~ black+ durat+ narr86+ nfarr86+ nparr86+ ptime86, data=df)
summary(i3lm_sev1)
```

Multiple R-squared > 0 is observed in every regression => first criterion is met.  

2. Check if errors and instruments are uncorrelated.
```{r, include=TRUE}
resid_sev1<-resid(IV_sev1)
lm_resid_sev1<-lm(resid_sev1~black+ durat+ narr86+ nfarr86+ nparr86+ ptime86, data=df)
summary(lm_resid_sev1)
```
A really small multiple R-squared is observed. The p-values of variables are considerably higher than 0.05 significance level. 
What can be done in addition is a test on $$ n*R^{2} $$ , where  $$ R^{2}$$ is the non-centered $$ R^{2} $$ 
```{r, include=TRUE}
0.0008356*2725
```
Which is smaller than the Chi-square value on 2 df and 0.05 significanse level=> also the second criterion is met. 

####Summary of the IV-Model
```{r, include=TRUE}
summary(IV_sev1)
```
Here a high R-squared is observed. Tottime and black are the only significant variables.
######################################
#############Georgi###################
######################################

## Simple OLS Regression, LPM

### OLS estimation

```{r, echo=FALSE}
# with all viariables
ols_all <- lm(narr86 ~ pcnv + avgsen + tottime + ptime86 + qemp86 + inc86 + durat + black + hispan + born60 + pcnvsq + pt86sq + inc86sq , data=df)
summary(ols_all)
```

### Model:
$$ narr86 = \beta_0 + \beta_1\ pcnv + \beta_2\ ptime86 +  \beta_3\ inc86 +  \beta_4\ black +  \beta_5\ hispan +  \beta_6\ pcnvsq+ \beta_7\ pt86sq+ \beta_8\ inc86sq   $$

```{r, echo=FALSE}
#with chosen variables
ols <- lm(narr86 ~ pcnv + ptime86 + inc86 + black + hispan + pcnvsq + pt86sq + inc86sq  , data=df)
summary(ols)
```

## IV Regression

### Model:



### Generalized IV estimation


### 2SLS estimation


## LOGIT model
creating a binary variable arr86, when a person gets arrested at least once.
```{r}
df$arr86 <- ifelse(df$narr86>0 ,1 ,0)
```

```{r}
log_all <- glm(arr86 ~ pcnv + avgsen + tottime + ptime86 + qemp86 + inc86 + durat + black + hispan + born60 + pcnvsq + pt86sq + inc86sq , data = df, family=binomial(link = "logit"))

summary(log_all)
```
```{r}
log <- glm(arr86 ~   ptime86 + qemp86 + inc86  + black + hispan + pcnvsq + pt86sq + inc86sq , data = df, family=binomial(link = "logit"))

summary(log)
```

For comparison
```{r}
prob <- glm(arr86 ~   ptime86 + qemp86 + inc86  + black + hispan + pcnvsq + pt86sq + inc86sq , data = df, family=binomial(link = "probit"))

summary(prob)
```

## Calculation of MC Faddens pseudo R^2
```{r}
1-(prob$deviance/prob$null.deviance)
```



## parameter logit probit check
prob/log
slide 21 ... factor 1.6

##Average marginal effect
```{r}
# for logit
fav <- mean(dnorm(predict(log,type="link")))
fav*coef(log)
```

## Predicition of cutoff
```{r}
tab <- table(true= df$arr86, pred= round(fitted(log)))
tab

tabp <-round(100* c(tab[1,1]+tab[2,2], tab[2,1]+ tab[1,2]/sum(tab)), digits = 2)
tabp
```


## ROC
```{r}
pred <- prediction(fitted(log),df$arr86)
plot(performance(pred, "acc"))

plot(performance(pred,"tpr", "fpr"))
abline(0,1,lty=2)
```

## Ordered Logit Model
```{r}
library("oglmx")
results.oprob<-oglmx(narr86 ~  ptime86 + qemp86 + inc86  + black + hispan + pcnvsq + pt86sq + inc86sq, data=df, link="probit",
                     constantMEAN = FALSE, constantSD = FALSE,
                     delta=0,threshparam = NULL)
summary(results.oprob)

"marginal effects"
margins.oglmx(results.oprob,ascontinuous = TRUE)

```

##WORK IN PROGRESS:Alternative model with fixed thresholds (restrictions)
```{r}

results.oprob1<-oglmx(y ~ x1 + x2, ~ x1 + x2, data=sampleframe,
                        constantMEAN = FALSE, constantSD = FALSE)
"Alternative model with fixed thresholds"

results.oprob1alt<-oglmx(y ~ x1 + x2, ~ x1 + x2, data=sampleframe,
                        constantMEAN = TRUE, constantSD = TRUE,
                        threshparam=c(-0.5,NA,1.5))
summary(results.oprob1)
summary(results.oprob1alt)
```

##WORK IN PROGRESS:Some Testing
```{r}
library("lmtest")

lrtest(results.oprob,results.oprobalt)
```
## Truncated model, let's see
